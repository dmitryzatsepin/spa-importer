# –†–µ–∑—é–º–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: –ú–µ—Ö–∞–Ω–∏–∑–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤

**–î–∞—Ç–∞:** 21 –æ–∫—Ç—è–±—Ä—è 2025  
**–ó–∞–¥–∞—á–∞:** 2.3 - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. –ò—Å–∫–ª—é—á–µ–Ω–∏–µ TokenRefreshException

üìÅ `app/Services/Bitrix24/Exceptions/TokenRefreshException.php`

–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –æ—à–∏–±–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤.

### 2. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ Portal

üìÅ `app/Models/Portal.php`

–î–æ–±–∞–≤–ª–µ–Ω–æ:

- `needsTokenRefresh($bufferSeconds = 60)` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- `updateTokens($accessToken, $refreshToken, $expiresIn)` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ Bitrix24APIService

üìÅ `app/Services/Bitrix24/Bitrix24APIService.php`

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä `Portal $portal` –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ
- –ú–µ—Ç–æ–¥ `ensureValidToken()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
- –ú–µ—Ç–æ–¥ `refreshToken()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ OAuth API
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –º–µ—Ç–æ–¥—ã `call()` –∏ `callBatch()`

### 4. –¢–µ—Å—Ç–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã

üìÅ `app/Http/Controllers/TestBitrix24Controller.php` - –º–µ—Ç–æ–¥ `testTokenRefresh()`  
üìÅ `routes/web.php` - –º–∞—Ä—à—Ä—É—Ç `/test-bitrix24/token-refresh`  
üìÅ `test-token-refresh.php` - –∫–æ–Ω—Å–æ–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç  

### 5. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

üìÅ `app/Services/Bitrix24/README.md` - –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏  
üìÅ `tasks/02-bitrix24-integration/03-implement-token-refresh-mechanism_task_completed.md`

## –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### ‚úÖ –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å

```php
$service = new Bitrix24APIService($portal->domain, $portal->access_token, 30, 5, $portal);
$result = $service->call('crm.deal.list'); // —Ç–æ–∫–µ–Ω –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
```

### ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

–ï—Å–ª–∏ `Portal` –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ (–±–µ–∑ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è).

### ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- Credentials –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### ‚úÖ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á

Jobs –º–æ–≥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è - —Ç–æ–∫–µ–Ω—ã –æ–±–Ω–æ–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### HTTP-—ç–Ω–¥–ø–æ–∏–Ω—Ç

```http
GET /test-bitrix24/token-refresh?portal_id=1
```

### –ö–æ–Ω—Å–æ–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç

```bash
php test-token-refresh.php --expire
```

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏–µ–º–∫–∏

- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º API-–∑–∞–ø—Ä–æ—Å–æ–º
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ —Å –±—É—Ñ–µ—Ä–æ–º 60 —Å–µ–∫—É–Ω–¥
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ –≤ –ë–î
- ‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- ‚úÖ –í—ã–±—Ä–æ—Å TokenRefreshException –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ "–ø–∞–¥–∞–µ—Ç" –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–í `.env`:

```env
BITRIX24_CLIENT_ID=your_client_id
BITRIX24_CLIENT_SECRET=your_client_secret
```

–í `config/services.php`:

```php
'bitrix24' => [
    'client_id' => env('BITRIX24_CLIENT_ID'),
    'client_secret' => env('BITRIX24_CLIENT_SECRET'),
],
```

## –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤

- ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö
- ‚úÖ –§–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á–∞—Ö (Jobs)
- ‚úÖ –ö–æ–º–∞–Ω–¥–∞—Ö Artisan
- ‚úÖ –õ—é–±–æ–º –∫–æ–¥–µ, —Ä–∞–±–æ—Ç–∞—é—â–µ–º —Å –ë–∏—Ç—Ä–∏–∫—Å24 API

---

**–°–ª–µ–¥—É—é—â–∞—è –∑–∞–¥–∞—á–∞:** 3.1 - –°–æ–∑–¥–∞–Ω–∏–µ API-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
