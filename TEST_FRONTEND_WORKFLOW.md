# Тестирование фронтенд-воркфлоу импорта

## Быстрый старт

### 1. Запуск серверов

```bash
# Терминал 1 - Laravel
cd spa-importer
php artisan serve

# Терминал 2 - Vite (фронтенд)
cd spa-importer
npm run dev
```

### 2. Открыть приложение

Перейти по адресу: `http://localhost:8000`

## Тестовый сценарий

### Шаг 1: Выбор смарт-процесса

- Должен загрузиться список смарт-процессов
- Выбрать любой процесс из списка
- **Проверка в Network**: `GET /api/v1/smart-processes?portal_id=1`
- **Проверка в Network**: `GET /api/v1/smart-processes/{id}/fields?portal_id=1`

### Шаг 2: Загрузка файла

- Выбрать CSV файл (можно использовать `test_data.csv`)
- Нажать "Продолжить"
- Файл должен быть прочитан и отображены его колонки

### Шаг 3: Маппинг полей

- Сопоставить колонки из файла с полями процесса
- Нажать "Proceed to Import"
- **Проверка в Network**: `POST /api/v1/import` с FormData

### Шаг 4: Отслеживание прогресса

- После запуска импорта должен открыться экран прогресса
- **Проверка в Network**: периодические `GET /api/v1/import/{jobId}/status` каждые 2 секунды
- Прогресс-бар должен обновляться
- Счетчик обработанных строк должен увеличиваться

### Шаг 5: Завершение

- Когда статус станет `completed`:
  - Запросы статуса должны прекратиться
  - Должна появиться кнопка "Начать новый импорт"
  - Должна отображаться итоговая статистика

## Проверка критических моментов

### ✅ Polling останавливается

Открыть DevTools → Network → фильтр "status"

- Во время импорта: регулярные запросы каждые 2 сек
- После завершения: запросы должны прекратиться

### ✅ Интерфейс не блокируется

- Во время импорта интерфейс остается отзывчивым
- Можно видеть обновления прогресса в реальном времени
- Нет "зависаний" браузера

### ✅ Обработка ошибок

Для тестирования ошибок можно временно:

1. Остановить Laravel сервер во время импорта
2. Проверить, что отображается сообщение об ошибке
3. Убедиться, что polling продолжается/останавливается корректно

## Проверка API-эндпоинтов

### Смарт-процессы

```bash
curl http://localhost:8000/api/v1/smart-processes?portal_id=1
```

### Поля процесса

```bash
curl http://localhost:8000/api/v1/smart-processes/128/fields?portal_id=1
```

### Запуск импорта

```bash
curl -X POST http://localhost:8000/api/v1/import \
  -F "file=@test_data.csv" \
  -F "portal_id=1" \
  -F "entity_type_id=128" \
  -F "field_mappings[0][source]=name" \
  -F "field_mappings[0][target]=title"
```

### Статус импорта

```bash
curl http://localhost:8000/api/v1/import/1/status
```

## Ожидаемое поведение

### Mock API (текущий)

- Возвращает фиктивные данные
- Симулирует прогресс импорта
- Не требует реального подключения к Битрикс24

### Real API (для продакшена)

- Требует настроенного OAuth
- Работает с реальными данными Битрикс24
- Выполняет импорт через очереди

## Отладка

### Проблема: polling не останавливается

**Решение:** Проверить, что ImportProgress.tsx использует обновленный код с правильной очисткой интервала

### Проблема: API возвращает 404

**Решение:** Проверить, что routes/api.php содержит нужные маршруты

### Проблема: CORS ошибки

**Решение:** Убедиться, что Vite proxy настроен (vite.config.ts) или API и фронтенд на одном домене

## Замедление импорта для тестирования

Для наглядного тестирования прогресса можно добавить задержку в Mock контроллере:

```php
// В MockImportController::getImportStatus()
sleep(1); // замедлит обработку для визуального контроля
```

Или в реальном ProcessImportJob:

```php
// В ProcessImportJob::handle()
foreach ($rows as $row) {
    // ... обработка
    sleep(1); // 1 секунда задержки на каждую строку
}
```

## Результат успешного теста

- ✅ Все API-запросы выполняются успешно
- ✅ Прогресс обновляется в реальном времени
- ✅ Polling автоматически останавливается
- ✅ Интерфейс не блокируется
- ✅ Ошибки обрабатываются корректно
- ✅ Можно запустить новый импорт после завершения
